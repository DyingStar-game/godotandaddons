name: üèÅ Windows Builds
on:
  workflow_call:

# Global Settings
env:
  SCONS_CACHE_MSVC_CONFIG: true
  PYTHONIOENCODING: utf8

jobs:
  build-windows:
    # Windows 10 with latest image
    runs-on: windows-latest
    name: build-windows-editor
    timeout-minutes: 240

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: 'godotengine/godot'
          ref: '4.5.1-stable'
          submodules: recursive

      - name: Setup Python and SCons
        uses: ./.github/actions/godot-deps

      - name: Compilation editor
        run: |
          scons platform=windows target=editor production=yes precision=double module_mono_enabled=yes

      # - name: Compilation template_debug
      #   run: |
      #     scons platform=windows target=template_debug precision=double module_mono_enabled=yes

      # - name: Compilation template_release
      #   run: |
      #     scons platform=windows target=template_release production=yes precision=double module_mono_enabled=yes

      - name: Generate glue sources
        run: ./bin/godot.windows.editor.double.x86_64.mono.exe --headless --generate-mono-glue modules/mono/glue


      # - name: Generate glue sources
      #   run: |
      #     cd bin
      #     ./godot.windows.editor.double.x86_64.mono.exe --headless --generate-mono-glue modules/mono/glue
      #     Move-Item -Path "modules/mono/glue/GodotSharp/GodotSharp/Generated" -Destination "../modules/mono/glue/GodotSharp/GodotSharp/" -Force
      #     Move-Item -Path "modules/mono/glue/GodotSharp/GodotSharpEditor/Generated" -Destination "../modules/mono/glue/GodotSharp/GodotSharpEditor/" -Force
      #     Remove-Item -Path "modules" -Recurse -Force

      - name: Install dotnet SDK 8.0
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '8.0.x'

      - name: Init nuget
        run: |
          New-Item -ItemType Directory -Force -Path D:\a\godotandaddons\godotandaddons\nuget
          dotnet nuget add source D:\a\godotandaddons\godotandaddons\nuget --name MyLocalNugetSource`

      - name: Build .NET assemblies
        run: |
          python ./modules/mono/build_scripts/build_assemblies.py --godot-output-dir ./bin --push-nupkgs-local D:\a\godotandaddons\godotandaddons\nuget --precision=double

      - name: Prepare artifact
        run: |
          Remove-Item bin/* -Include *.exp,*.lib -Force

      - name: Upload artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: windows-editor-mono-double






