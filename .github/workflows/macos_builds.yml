name: 🍎 macOS Builds
on:
  workflow_call:

jobs:
  build-macos:
    runs-on: macos-latest
    name: build-macos-editor
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: 'godotengine/godot'
          ref: '4.5.1-stable'
          submodules: recursive

      - name: Select Xcode 16
        run: sudo xcode-select -s /Applications/Xcode_16.2.app

      - name: Setup Python and SCons
        uses: ./.github/actions/godot-deps

      - name: Setup Vulkan SDK
        id: vulkan-sdk
        run: |
          if sh misc/scripts/install_vulkan_sdk_macos.sh; then
            echo "VULKAN_ENABLED=yes" >> "$GITHUB_OUTPUT"
          else
            echo "::warning::macOS: Vulkan SDK installation failed, building without Vulkan support."
            echo "VULKAN_ENABLED=no" >> "$GITHUB_OUTPUT"
          fi
        continue-on-error: true

      - name: Compilation (x86_64)
        uses: ./.github/actions/godot-build
        with:
          scons-flags: precision=double module_mono_enabled=yes arch=x86_64 vulkan=${{ steps.vulkan-sdk.outputs.VULKAN_ENABLED }} production=yes
          platform: macos
          target: editor

      - name: Compilation (arm64)
        uses: ./.github/actions/godot-build
        with:
          scons-flags: precision=double module_mono_enabled=yes arch=arm64 vulkan=${{ steps.vulkan-sdk.outputs.VULKAN_ENABLED }} production=yes
          platform: macos
          target: editor

      - name: Generate glue sources (x86_64)
        run: |
          cd bin
          ./godot.macos.editor.double.x86_64.mono --headless --generate-mono-glue modules/mono/glue

      - name: Generate glue sources (arm64)
        run: |
          cd bin 
          ./godot.macos.editor.double.arm64.mono --headless --generate-mono-glue modules/mono/glue
          mv -f modules/mono/glue/GodotSharp/GodotSharp/Generated ../modules/mono/glue/GodotSharp/GodotSharp/
          mv -f modules/mono/glue/GodotSharp/GodotSharpEditor/Generated ../modules/mono/glue/GodotSharp/GodotSharpEditor/
          rm -fr modules

      - name: Build .NET assemblies
        run: ./modules/mono/build_scripts/build_assemblies.py --godot-output-dir ./bin --godot-platform=macos --precision=double 

      - name: Prepare artifact
        run: |
          ls bin/
          # lipo -create ./bin/godot.macos.${{ matrix.target }}.double.x86_64 ./bin/godot.macos.${{ matrix.target }}.double.arm64 -output ./bin/godot.macos.${{ matrix.target }}.double.universal
          # rm ./bin/godot.macos.${{ matrix.target }}.double.x86_64 ./bin/godot.macos.${{ matrix.target }}.double.arm64
          strip bin/godot.*
          chmod +x bin/godot.*

      - name: Upload artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: macos-editor-mono-double

