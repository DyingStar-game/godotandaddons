name: üêß Linux Builds
on:
  workflow_call:

jobs:
  build-linux:
    # Stay one LTS before latest to increase portability of Linux artifacts.
    runs-on: ubuntu-22.04
    name: build-linux-editor
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: 'godotengine/godot'
          ref: '4.5.1-stable'
          submodules: recursive

      - name: Setup dependencies
        run: |
          sudo apt-get update
          sudo apt-get install libwayland-bin scons  # TODO: Figure out somehow how to embed this one.

      - name: Force remove preinstalled .NET SDKs
        run: |
          sudo rm -rf /usr/share/dotnet/*

      - name: Setup older .NET SDK as baseline
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: retry install dotnet 8
        run: |
          sudo apt --reinstall install dotnet8 dotnet-sdk-8.0 dotnet-runtime-8.0

      - name: Compilation editor
        run: |
          scons platform=linuxbsd target=editor production=yes precision=double module_mono_enabled=yes

      - name: Compilation template_debug
        run: |
          scons platform=linuxbsd target=template_debug precision=double module_mono_enabled=yes

      - name: Compilation template_release
        run: |
          scons platform=linuxbsd target=template_release production=yes precision=double module_mono_enabled=yes

      - name: Generate C# glue
        run: |
          cd bin
          ./godot.linuxbsd.editor.double.x86_64.mono --headless --generate-mono-glue modules/mono/glue
          mv -f modules/mono/glue/GodotSharp/GodotSharp/Generated ../modules/mono/glue/GodotSharp/GodotSharp/
          mv -f modules/mono/glue/GodotSharp/GodotSharpEditor/Generated ../modules/mono/glue/GodotSharp/GodotSharpEditor/
          rm -fr modules

      - name: Build .NET solutions
        run: |
          dotnet --info
          python ./modules/mono/build_scripts/build_assemblies.py --godot-output-dir=./bin --precision=double

      - name: clean obj folder
        run: |
          rm -fr bin/obj

      - name: Prepare artifact
        run: |
          strip bin/godot.*
          chmod +x bin/godot.*

      - name: Upload artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: linux-editor-mono-double

